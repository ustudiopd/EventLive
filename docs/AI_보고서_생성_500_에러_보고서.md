# AI 보고서 생성 500 에러 보고서

## 📋 요약

**발생 일시**: 2025-01-XX  
**에러 코드**: 500 Internal Server Error  
**에러 메시지**: "AI 분석 생성에 실패했습니다"  
**영향 범위**: 새 파이프라인(`useNewPipeline = true`)을 사용한 분석 보고서 생성

## 🔍 에러 상세

### 클라이언트 에러
```
POST http://localhost:3000/api/event-survey/campaigns/e80d8760-787e-48e9-85d4-798c4d156a7a/analysis/generate 500 (Internal Server Error)

보고서 생성 오류: Error: AI 분석 생성에 실패했습니다
    at handleGenerateReport (AnalysisReportSection.tsx:1053:15)
```

### 서버 에러 (예상)
- **에러 코드**: `SCHEMA_VALIDATION_FAILED`
- **에러 메시지**: "AI 응답 형식이 올바르지 않습니다"
- **발생 위치**: `lib/surveys/analysis/generateDecisionPack.ts` - Zod 스키마 검증 실패

## 🔄 발생 흐름

1. **클라이언트**: `AnalysisReportSection.tsx`에서 보고서 생성 요청
2. **API**: `/api/event-survey/campaigns/[campaignId]/analysis/generate` POST 요청
3. **새 파이프라인 실행**:
   - ✅ Analysis Pack 생성 성공
   - ✅ Decision Pack LLM 호출 성공
   - ❌ Decision Pack 스키마 검증 실패
4. **에러 반환**: 500 에러 및 "AI 분석 생성에 실패했습니다" 메시지

## 🎯 근본 원인 분석

### 1. LLM 응답 형식 불일치
- Gemini API가 반환한 JSON이 `DecisionPackSchema`와 일치하지 않음
- 가능한 원인:
  - 필수 필드 누락 (`decisionCards`, `actionBoard`, `playbooks`, `surveyNextQuestions`)
  - 필드 타입 불일치 (배열이어야 하는데 객체로 반환 등)
  - 중첩된 객체 구조 오류

### 2. 스키마 검증 실패 처리 부족
- 현재는 스키마 검증 실패 시 즉시 에러를 던짐
- 재시도 로직이 있지만, 스키마 검증 실패 시 재시도가 제대로 작동하지 않을 수 있음

### 3. 에러 메시지 부족
- 클라이언트에 전달되는 에러 메시지가 너무 일반적
- 디버깅에 필요한 상세 정보 부족

## 📊 영향도 분석

### 심각도
- **높음**: 새 파이프라인을 사용하는 모든 분석 보고서 생성 실패

### 영향받는 기능
- AI 고도화 보고서 생성 (Decision Pack 포함)
- 기존 파이프라인은 정상 작동 (`useNewPipeline = false`)

## 🛠️ 해결 방안

### 즉시 조치 (완료)
1. ✅ **상세 로깅 추가**
   - `generateDecisionPack.ts`에 스키마 검증 실패 시 상세 로그 추가
   - 어떤 필드가 문제인지 명확히 표시

2. ✅ **에러 처리 개선**
   - 스키마 검증 실패 시 구체적인 에러 메시지 제공
   - 재시도 로직 개선

### 단기 조치 (권장)
1. **LLM 프롬프트 개선**
   - Decision Pack 스키마를 더 명확하게 설명
   - 예시 JSON 제공
   - 필수 필드 강조

2. **스키마 검증 강화**
   - 부분 검증 허용 옵션 추가
   - 누락된 필드에 대한 기본값 제공

3. **재시도 로직 개선**
   - 스키마 검증 실패 시 프롬프트에 구체적인 오류 정보 포함
   - 최대 재시도 횟수 증가 고려

### 장기 조치 (검토 필요)
1. **Structured Output 사용**
   - Gemini API의 Structured Output 기능 활용
   - JSON 스키마를 직접 전달하여 형식 보장

2. **폴백 메커니즘**
   - 스키마 검증 실패 시 기존 파이프라인으로 자동 전환
   - 부분적인 Decision Pack이라도 사용 가능하도록 처리

## 📝 디버깅 가이드

### 서버 로그 확인 사항
```bash
# 다음 로그를 확인하세요:
[generateDecisionPack] LLM 응답 길이: ...
[generateDecisionPack] LLM 응답 일부: ...
[generateDecisionPack] 파싱된 데이터 구조: ...
[generateDecisionPack] 스키마 검증 실패: {
  issuesCount: ...,
  issues: [...],
  parsedData: {...}
}
```

### 확인할 필드
1. **issues 배열**: 어떤 필드가 문제인지 확인
2. **parsedData**: LLM이 실제로 생성한 데이터 구조 확인
3. **LLM 응답 일부**: JSON 파싱 전 원본 응답 확인

## 🔧 수정된 파일

1. `lib/surveys/analysis/generateDecisionPack.ts`
   - 스키마 검증 실패 시 상세 로그 추가
   - 에러 메시지 개선

2. `app/api/event-survey/campaigns/[campaignId]/analysis/generate/route.ts`
   - 에러 처리 개선
   - 구체적인 에러 코드 제공

## 📌 다음 단계

1. **서버 로그 확인**
   - 실제 스키마 검증 실패 원인 파악
   - 어떤 필드가 누락되었는지 확인

2. **LLM 프롬프트 수정**
   - 검증 실패 원인에 따라 프롬프트 개선
   - 예시 JSON 추가

3. **테스트**
   - 수정 후 동일한 캠페인으로 재테스트
   - 다른 캠페인으로도 테스트

## 🚨 우선순위

- **높음**: 서버 로그 확인 및 원인 파악
- **중간**: LLM 프롬프트 개선
- **낮음**: Structured Output 적용 검토

---

**작성일**: 2025-01-XX  
**작성자**: AI Assistant  
**상태**: 조사 중

