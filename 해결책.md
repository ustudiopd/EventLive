ë‹¤ìŒ ê³„íš, **ê·¸ëŒ€ë¡œ ì§„í–‰í•˜ë©´ ë³´ì•ˆÂ·ì•ˆì •ì„± ë¦¬ìŠ¤í¬ê°€ í½ë‹ˆë‹¤.**
í•µì‹¬ì€ **ìŠˆí¼ì–´ë“œë¯¼ ê¶Œí•œì„ â€œJWT í´ë ˆì„ ê¸°ë°˜â€ìœ¼ë¡œ ì „í™˜**í•˜ê³ , **ë¶€íŠ¸ìŠ¤íŠ¸ë©(ìµœì´ˆ ê³„ì • ìƒì„±)ì€ ì„œë²„ ì „ìš©Â·ì¼íšŒì„± ìŠ¤í¬ë¦½íŠ¸**ë¡œ ì²˜ë¦¬í•˜ë©°, **ë¯¸ë“¤ì›¨ì–´/í´ë¼ì´ì–¸íŠ¸ì—ì„œ `profiles` ì§ì ‘ ì¡°íšŒë¥¼ ì œê±°**í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. í˜„ì¬ ë³´ê³ ëœ **RLS ë¬´í•œ ì¬ê·€** ì´ìŠˆë„ ì´ ì „í™˜ìœ¼ë¡œ í•¨ê»˜ í•´ì†Œë©ë‹ˆë‹¤. 

---

## âœ… ê²°ë¡  (ìš”ì•½)

* **ìŠ¹ì¸ (ë‹¨, ì•„ë˜ ë³€ê²½ì‚¬í•­ ë°˜ì˜ í•„ìˆ˜)**

  1. `app/api/admin/create-super-admin/route.ts` ë°©ì‹ **íê¸°** â†’ **ì„œë²„ ì „ìš© ë¶€íŠ¸ìŠ¤íŠ¸ë© ìŠ¤í¬ë¦½íŠ¸**ë¡œ ëŒ€ì²´
  2. **JWT `app_metadata.is_super_admin`**ì— ê¶Œí•œ í”Œë˜ê·¸ ì €ì¥ â†’ ë¯¸ë“¤ì›¨ì–´/ì„œë²„ì—ì„œ **JWTë§Œ ì½ì–´ ì²´í¬**
  3. **RLS ì •ì±…**ì€ `auth.jwt()` í´ë ˆì„ë§Œ ì°¸ì¡°í•˜ë„ë¡ ë‹¨ìˆœí™”(í…Œì´ë¸” ì¡°íšŒ/í•¨ìˆ˜ ì¬ê·€ ê¸ˆì§€)
  4. ìŠˆí¼ ëŒ€ì‹œë³´ë“œ/ê´€ë¦¬ APIëŠ” **ì„œë¹„ìŠ¤ í‚¤(ì„œë²„ ì „ìš©)**ë¡œ í˜¸ì¶œí•´ **ì§‘ê³„Â·ì „ì—­ ì¡°íšŒ ì„±ëŠ¥** í™•ë³´
  5. **ê°ì‚¬ ë¡œê·¸(Audit)**ì™€ **ê°•ë ¥í•œ ë ˆì´íŠ¸ ë¦¬ë°‹/ì•¡ì„¸ìŠ¤ ì œì–´** ì¶”ê°€

---

## ğŸ”´ ê³ ìœ„í—˜ ì§€ì ê³¼ ëŒ€ì²´ì•ˆ

### 1) ê³µê°œ APIë¡œ ìŠˆí¼ì–´ë“œë¯¼ ê³„ì • ìƒì„± (í•˜ë“œì½”ë“œ ë¹„ë²ˆ)

* ì œì•ˆì•ˆ: `app/api/admin/create-super-admin/route.ts` ì—ì„œ
  `ì´ë©”ì¼: admin / ë¹„ë°€ë²ˆí˜¸: uslab3300 / is_super_admin: true`
* **ë¬¸ì œ**: ë¼ìš°íŠ¸ê°€ ë…¸ì¶œë˜ë©´ ê¶Œí•œ íƒˆì·¨/ì¬ìƒì„± ê°€ëŠ¥. ë¹„ë°€ë²ˆí˜¸ í•˜ë“œì½”ë”©ì€ ì¦‰ì‹œ ìœ ì¶œ ë¦¬ìŠ¤í¬.
* **ëŒ€ì²´**: **ë¶€íŠ¸ìŠ¤íŠ¸ë© ìŠ¤í¬ë¦½íŠ¸**(Node ì‹¤í–‰) ë˜ëŠ” **DB ë§ˆì´ê·¸ë ˆì´ì…˜** + **í™˜ê²½ë³€ìˆ˜** ê¸°ë°˜.

  * ì‹¤í–‰ ì£¼ì²´ëŠ” ì„œë²„/CIì—ì„œë§Œ. 1íšŒ ì‹¤í–‰ í›„ ë¹„í™œì„±í™”.

### 2) ë¯¸ë“¤ì›¨ì–´/í´ë¼ì´ì–¸íŠ¸ì—ì„œ `profiles` ì¡°íšŒë¡œ ê¶Œí•œ íŒë³„

* **ë¬¸ì œ**: í˜„ì¬ë„ `profiles` RLSê°€ í•¨ìˆ˜â†’í…Œì´ë¸” ìˆœí™˜ìœ¼ë¡œ **ë¬´í•œ ì¬ê·€/500** ë°œìƒ. 
* **ëŒ€ì²´**: **JWT í´ë ˆì„(`app_metadata.is_super_admin`)ë§Œ ì‚¬ìš©**. ë¯¸ë“¤ì›¨ì–´/í´ë¼ì´ì–¸íŠ¸ì˜ DB ì¡°íšŒ ì œê±°.

### 3) RLSê°€ í•¨ìˆ˜/í…Œì´ë¸”ì„ ìƒí˜¸ ì°¸ì¡°

* **ë¬¸ì œ**: `security definer`ì—¬ë„ SupabaseëŠ” **RLSë¥¼ ì ìš©** â†’ ì¬ê·€. 
* **ëŒ€ì²´**: **RLS = ìˆœìˆ˜ í´ë ˆì„ íŒì •**(í…Œì´ë¸” ì¡°íšŒ ê¸ˆì§€). ìŠˆí¼ ê¶Œí•œì€ `auth.jwt()`ë§Œ í™•ì¸.

---

## ğŸ”§ ìˆ˜ì •ëœ ì‹¤í–‰ ê³„íš (íŒŒì¼ êµ¬ì¡° ìœ ì§€, êµ¬í˜„ ë°©ì‹ë§Œ ê°œì„ )

### A. ìŠˆí¼ì–´ë“œë¯¼ ë¶€íŠ¸ìŠ¤íŠ¸ë© (ì‹ ê·œ: **scripts/bootstrap-super-admin.ts**)

* ì„œë²„ì—ì„œë§Œ ì‹¤í–‰. í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©:

  * `SUPER_ADMIN_EMAIL`, `SUPER_ADMIN_PASSWORD` (ì´ˆê¸°ë§Œ), **ì ˆëŒ€ ì»¤ë°‹ ê¸ˆì§€**
* Supabase Admin APIë¡œ **ì‚¬ìš©ì ìƒì„±+ì´ë©”ì¼ ê²€ì¦** & `app_metadata.is_super_admin = true` ì„¤ì •.
* **Idempotent**(ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•´ë„ ì•ˆì „)í•˜ë„ë¡ â€œì¡´ì¬ ì‹œ ì—…ë°ì´íŠ¸â€ ì²˜ë¦¬.

> `app/api/admin/create-super-admin/route.ts` **ìƒì„± ê¸ˆì§€**(ê³µê°œ ë¼ìš°íŠ¸ ìœ„í—˜).
> ë¶€ë“ì´í•˜ê²Œ ë¼ìš°íŠ¸ê°€ í•„ìš”í•˜ë©´ `SUPER_BOOTSTRAP_TOKEN` í—¤ë”Â·IP allowlistÂ·ì¼íšŒì„± í† í°ìœ¼ë¡œ **ì¦‰ì‹œ íê¸° ì „ì œ**.

### B. ê¶Œí•œ í™•ì¸ (ë¯¸ë“¤ì›¨ì–´ ë° ì„œë²„)

* ê²½ë¡œ: `middleware.ts`
* **ë³€ê²½ì **: `profiles` ì¡°íšŒ **ì‚­ì œ** â†’ `supabase.auth.getUser()`ì˜ **JWT `app_metadata.is_super_admin`**ë§Œ ì‚¬ìš©.

```ts
// middleware.ts (ìš”ì§€)
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'
import { createServerClient } from '@supabase/ssr' // ë²„ì „ì— ë§ì¶° import ê²½ë¡œ ì¡°ì •

export async function middleware(req: NextRequest) {
  if (!req.nextUrl.pathname.startsWith('/super')) return NextResponse.next()

  const res = NextResponse.next()
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { cookies: { get: (k) => req.cookies.get(k)?.value, set: () => {}, remove: () => {} } }
  )

  const { data: { user } } = await supabase.auth.getUser()
  const isSuper = !!user?.app_metadata?.is_super_admin

  if (!user) return NextResponse.redirect(new URL('/sign-in', req.url))
  if (!isSuper) return NextResponse.redirect(new URL('/403', req.url))
  return res
}
```

> **í¬ì¸íŠ¸:** ë” ì´ìƒ `profiles`ë¥¼ ì½ì§€ ì•Šìœ¼ë¯€ë¡œ **RLS ì¬ê·€ê°€ ì›ì²œ ì°¨ë‹¨**ë©ë‹ˆë‹¤. 

### C. RLS ì •ì±…(ì˜ˆì‹œ) â€” **í´ë ˆì„ë§Œ** ì°¸ì¡°

```sql
-- agencies, clients ë“± ê³µí†µ (select/insert/update/delete ê°ê° ë¶„ë¦¬ ê¶Œì¥)
create policy "super can read all" on public.agencies
for select using (
  coalesce((auth.jwt()->'app_metadata'->>'is_super_admin')::boolean, false)
);

-- ë¹„ìŠˆí¼ ê¶Œí•œì€ ë³„ë„ ì •ì±…(ì†Œì† agency ê¸°ì¤€)ìœ¼ë¡œ ë¶„ë¦¬
```

> **ê¸ˆì§€:** RLSì—ì„œ í•¨ìˆ˜ í˜¸ì¶œë¡œ `profiles` ì¬ì¡°íšŒ ë˜ëŠ” ë‹¤ë¥¸ í…Œì´ë¸” ì¡°íšŒ â†’ ì¬ê·€ ìœ„í—˜. 

### D. ìŠˆí¼ ëŒ€ì‹œë³´ë“œ/ê´€ë¦¬ API (ì„œë²„ ì „ìš©, ì„œë¹„ìŠ¤ í‚¤ ì‚¬ìš©)

* `app/(super)/super/dashboard/page.tsx`
  â†’ `GET /api/super/stats` (ì„œë¹„ìŠ¤ ë¡¤ í‚¤ë¡œ ë¹ ë¥¸ ì§‘ê³„: ì—ì´ì „ì‹œ/í´ë¼ì´ì–¸íŠ¸/ì›¨ë¹„ë‚˜ ìˆ˜)
* `app/(super)/super/agencies/page.tsx`
  â†’ `GET/POST/PATCH/DELETE /api/super/agencies` (ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜)
* `app/(super)/super/clients/page.tsx`
  â†’ `GET /api/super/clients?agencyId=...` + ì»¤ì„œ ê¸°ë°˜
* ì§‘ê³„ ë¹„ìš©ì´ í¬ë©´ **ë¨¸í‹°ë¦¬ì–¼ë¼ì´ì¦ˆë“œ ë·° + ìŠ¤ì¼€ì¤„ ë¦¬í”„ë ˆì‹œ** ê³ ë ¤

### E. ë„¤ë¹„ê²Œì´ì…˜/ë ˆì´ì•„ì›ƒ

* `app/(super)/super/layout.tsx`ì— **ì‚¬ì´ë“œë°”**: ëŒ€ì‹œë³´ë“œ, ì—ì´ì „ì‹œ, í´ë¼ì´ì–¸íŠ¸, ê°ì‚¬ ë¡œê·¸
* ë¦¬ìŠ¤íŠ¸ëŠ” **ì»¤ì„œ ê¸°ë°˜ í˜ì´ì§€ë„¤ì´ì…˜**(ì´ë¯¸ ì±„íŒ…ì— ë„ì…í•˜ì‹  ë°©ì‹ ì¬ì‚¬ìš©)ìœ¼ë¡œ ì´ˆê¸° ë¡œë”©ì„ ê°€ë³ê²Œ

### F. ê°ì‚¬ ë¡œê·¸(Audit) & ìš´ì˜ ê°€ë“œ

* `audit_logs` í…Œì´ë¸”: actor(UserId), action, target_type/id, payload ìš”ì•½, ip, ua, ts
* ì„œë²„ API ë‹¨ì—ì„œ **ëª¨ë“  ì“°ê¸° ìš”ì²­ í›„ ë¡œê·¸ ê¸°ë¡**
* **ë ˆì´íŠ¸ ë¦¬ë°‹**(IP/ìœ ì €ë³„) + **CSRF ë³´í˜¸**(í¼/ì¿ í‚¤ ê¸°ë°˜) + **IP allowlist(ì„ íƒ)**

---

## ğŸ§© ëŒ€ì‹œë³´ë“œ UI/ë°ì´í„° ì„¤ê³„ íŒ

* **ìš”ì•½ ì¹´ë“œ**: ì´ ì—ì´ì „ì‹œ/í´ë¼ì´ì–¸íŠ¸/ì›¨ë¹„ë‚˜ ìˆ˜ + ì¦ê°(7ì¼/30ì¼ ì „ ëŒ€ë¹„)
  â†’ ì§‘ê³„ SQLì€ ì„œë²„ì—ì„œë§Œ, **ì„œë¹„ìŠ¤ í‚¤**ë¡œ ìˆ˜í–‰
* **ìµœê·¼ ëª©ë¡**: 20ê°œ ì»¤ì„œ í˜ì´ì§• + **ìŠ¤ì¼ˆë ˆí†¤ UI**
* **ë¹ ë¥¸ ì•¡ì…˜**: ì—ì´ì „ì‹œ ìƒì„± ëª¨ë‹¬, í´ë¼ì´ì–¸íŠ¸ ê²€ìƒ‰/ë°”ë¡œê°€ê¸°
* ì˜¤ë¥˜/ê¶Œí•œ ì—ëŸ¬ëŠ” **ì¹œì ˆí•œ 403/404** í˜ì´ì§€ë¡œ ë¶„ë¦¬

---

## ğŸ›¡ï¸ ë³´ì•ˆ ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸ (í•„ìˆ˜)

* [ ] **í•˜ë“œì½”ë“œ íŒ¨ìŠ¤ì›Œë“œ ì œê±°**, `.env`ë§Œ ì‚¬ìš©
* [ ] ë¶€íŠ¸ìŠ¤íŠ¸ë© ìŠ¤í¬ë¦½íŠ¸ **ì„œë²„ì—ì„œë§Œ ì‹¤í–‰**, ì €ì¥ì†Œì— ë¹„ë°€ë²ˆí˜¸ **ì»¤ë°‹ ê¸ˆì§€**
* [ ] `/super` ì ‘ê·¼ ì œì–´ëŠ” **JWT í´ë ˆì„ë§Œ** ì‚¬ìš©(ë¯¸ë“¤ì›¨ì–´ DB ì¡°íšŒ ê¸ˆì§€)
* [ ] ì„œë²„ APIëŠ” **ì„œë¹„ìŠ¤ ë¡¤ í‚¤** ì‚¬ìš©(í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œ ê¸ˆì§€)
* [ ] RLSëŠ” `auth.jwt()`ë§Œ ì°¸ì¡°, **í…Œì´ë¸”/í•¨ìˆ˜ ì¬ê·€ ê¸ˆì§€** 
* [ ] ê°ì‚¬ ë¡œê·¸ ê¸°ë¡ + ê²½ë³´(ì‹¤íŒ¨/ê¶Œí•œ ê±°ë¶€ ë‹¤ëŸ‰ ë°œìƒ)
* [ ] ë ˆì´íŠ¸ ë¦¬ë°‹/CSRF/ë¡œê·¸ì¸ ë³´í˜¸(2FA/SSOëŠ” ì°¨í›„)

---

## ğŸ§ª ë§ˆì´ê·¸ë ˆì´ì…˜/ì ìš© ìˆœì„œ (ì•ˆì „í•œ ë¡¤ì•„ì›ƒ)

1. **RLS ìˆ˜ì • ë°°í¬**: `auth.jwt()` ê¸°ë°˜ ì •ì±…ìœ¼ë¡œ êµì²´(ê¸°ì¡´ ì •ì±… ì£¼ì„ ì²˜ë¦¬)
2. **ë¯¸ë“¤ì›¨ì–´ ìˆ˜ì •**: `profiles` ì¡°íšŒ ì œê±° â†’ JWTë§Œ í™•ì¸ 
3. **ë¶€íŠ¸ìŠ¤íŠ¸ë© ì‹¤í–‰**: ìŠ¤í¬ë¦½íŠ¸ë¡œ ìŠˆí¼ì–´ë“œë¯¼ 1íšŒ ìƒì„±(+ `app_metadata`)
4. **ìŠˆí¼ API/í˜ì´ì§€ ë°°í¬**: ì„œë¹„ìŠ¤ í‚¤ ì‚¬ìš© + ê°ì‚¬ ë¡œê·¸ í™œì„±í™”
5. **ëª¨ë‹ˆí„°ë§**: ì—ëŸ¬/ê¶Œí•œê±°ë¶€/ì‘ë‹µì‹œê°„ ëŒ€ì‹œë³´ë“œ í™•ì¸

---

## ğŸ“ ì°¸ê³  êµ¬í˜„ ìŠ¤ë‹ˆí«

### 1) ìŠˆí¼ì–´ë“œë¯¼ ë¶€íŠ¸ìŠ¤íŠ¸ë© (ì„œë²„ ì „ìš© Node ìŠ¤í¬ë¦½íŠ¸)

```ts
// scripts/bootstrap-super-admin.ts (ì„œë²„ì—ì„œë§Œ ì‹¤í–‰)
import 'dotenv/config'
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY! // server-only
)

async function main() {
  const email = process.env.SUPER_ADMIN_EMAIL!
  const password = process.env.SUPER_ADMIN_PASSWORD!

  // 1) ì‚¬ìš©ì ìƒì„±(ìˆìœ¼ë©´ ì—ëŸ¬ â†’ ì—…ë°ì´íŠ¸ë¡œ ëŒ€ì²´)
  const { data, error } = await supabase.auth.admin.createUser({
    email,
    password,
    email_confirm: true,
    app_metadata: { is_super_admin: true },
  })
  if (error && !`${error.message}`.includes('already')) throw error

  // 2) ì¡´ì¬í•˜ëŠ” ê²½ìš° ì—…ë°ì´íŠ¸ë¡œ ìŠˆí¼ ê¶Œí•œ ë³´ì¥
  const userId = data?.user?.id ?? (await findUserIdByEmail(email)) // êµ¬í˜„ ë°©ì‹ì€ í™˜ê²½ì— ë§ê²Œ
  if (!userId) throw new Error('user not found')
  await supabase.auth.admin.updateUserById(userId, {
    app_metadata: { is_super_admin: true },
  })

  // 3) profiles ë™ê¸°í™”(ì„ íƒ)
  await supabase.from('profiles').upsert({ id: userId, email, is_super_admin: true })
  console.log('âœ… Super admin ready:', email)
}

main().catch((e) => { console.error(e); process.exit(1) })
```

> ì£¼: ê´€ë¦¬ API ë©”ì„œë“œ ì´ë¦„/ì‹œê·¸ë‹ˆì²˜ëŠ” Supabase SDK ë²„ì „ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ, í”„ë¡œì íŠ¸ ë²„ì „ì— ë§ì¶° ì¡°ì •í•˜ì„¸ìš”.

### 2) RLS ì˜ˆì‹œ (ìŠˆí¼ ì „ì—­ í—ˆìš© + ì¼ë°˜ ì‚¬ìš©ì ì •ì±… ë¶„ë¦¬)

```sql
-- super ì „ì—­ í—ˆìš©
create policy "super_select_all" on public.clients
  for select using (coalesce((auth.jwt()->'app_metadata'->>'is_super_admin')::boolean, false));

-- ì¼ë°˜ ì‚¬ìš©ì: ì†Œì† agency ê¸°ë°˜
create policy "agency_member_can_read" on public.clients
  for select using (exists (
    select 1 from public.agency_members m
    where m.user_id = auth.uid() and m.agency_id = clients.agency_id
  ));
```

---

## ğŸ“Œ ì´í‰

* **ê¸°ëŠ¥ ê³„íš ìì²´ëŠ” ì¢‹ìŠµë‹ˆë‹¤.** ë‹¤ë§Œ **ê¶Œí•œ/ë¶€íŠ¸ìŠ¤íŠ¸ë©/ì„±ëŠ¥** 3ì¶•ì„ ìœ„ì™€ ê°™ì´ ì†ë³´ë©´

  * í˜„ì¬ **RLS ë¬´í•œ ì¬ê·€** í•´ê²°, ë¯¸ë“¤ì›¨ì–´ 500 ì œê±°, ì´ˆê¸° ë¡œë”© ê°€ì†, ë³´ì•ˆìˆ˜ì¤€ ìƒí–¥ì„ í•œ ë²ˆì— ë‹¬ì„±í•©ë‹ˆë‹¤. 
* ìœ„ ë³€ê²½ì„ ë°˜ì˜í•˜ëŠ” ì¡°ê±´ìœ¼ë¡œ **ì§„í–‰ ìŠ¹ì¸**ì„ ì¶”ì²œí•©ë‹ˆë‹¤.
  í•„ìš”í•œ ê²½ìš°, ìœ„ ìŠ¤ë‹ˆí«ì„ ë°”ë¡œ í”„ë¡œì íŠ¸ì— ë§ì¶° ë“œë¼ì´ëŸ°(ë¡œì»¬) â†’ ìŠ¤í…Œì´ì§• â†’ í”„ë¡œë•ì…˜ ìˆœìœ¼ë¡œ ì ìš©í•˜ì„¸ìš”.
