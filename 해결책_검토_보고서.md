# 해결책.md 검토 보고서

## 📋 검토 개요

**검토 대상**: `해결책.md` - RLS 무한 재귀 문제 해결 방안  
**검토 일시**: 2025-11-17  
**검토자**: AI Assistant  
**결론**: ✅ **승인 (수정 사항 반영 필요)**

---

## ✅ 검토 결과 요약

### 전체 평가: **매우 우수한 해결 방안**

`해결책.md`의 제안은 현재 프로젝트의 RLS 무한 재귀 문제를 근본적으로 해결할 수 있는 **실용적이고 안전한 접근 방식**입니다. 다만, 현재 프로젝트 상태를 고려한 몇 가지 **수정 및 보완 사항**이 필요합니다.

---

## 🔍 현재 프로젝트 상태 분석

### 1. 현재 구현 상태

#### ✅ 이미 구현된 부분
- ✅ `scripts/seed-super-admin.ts`: 부트스트랩 스크립트 존재 (서버 전용)
- ✅ `lib/supabase/admin.ts`: Admin Supabase 클라이언트 구현
- ✅ `app/(super)/super/*`: 슈퍼 관리자 페이지 구조 존재
- ✅ `audit_logs` 테이블: 감사 로그 시스템 존재

#### ❌ 미구현/문제점
- ❌ JWT `app_metadata.is_super_admin` 미사용 (현재 `profiles.is_super_admin`만 사용)
- ❌ `middleware.ts`에서 `profiles` 테이블 직접 조회 (RLS 재귀 발생)
- ❌ `app/page.tsx`에서 클라이언트 측 `profiles` 조회
- ❌ `lib/auth/guards.ts`에서 `profiles` 테이블 조회
- ❌ RLS 정책에서 `public.me` 뷰 사용 (순환 참조)

### 2. 영향 받는 코드 범위

**직접 영향**: 약 **30개 이상의 파일**에서 `profiles.is_super_admin` 조회
- `middleware.ts`
- `app/page.tsx`
- `lib/auth/guards.ts`
- `app/api/auth/dashboard/route.ts`
- `app/api/webinars/**/*.ts` (다수)
- `app/(webinar)/webinar/**/*.tsx` (다수)

---

## 📝 해결책.md 제안 검토

### A. 슈퍼어드민 부트스트랩 ✅ **승인**

#### 제안 내용
- `scripts/bootstrap-super-admin.ts` 생성
- `app_metadata.is_super_admin = true` 설정
- 환경변수 기반 (하드코딩 금지)

#### 현재 상태
- ✅ `scripts/seed-super-admin.ts` 이미 존재
- ❌ `app_metadata` 설정 누락 (현재 `profiles`만 설정)

#### 수정 필요 사항
```typescript
// scripts/seed-super-admin.ts 수정 필요
const { data: authData, error: authError } = await admin.auth.admin.createUser({
  email,
  password: tempPassword,
  email_confirm: true,
  app_metadata: { is_super_admin: true }, // ✅ 추가 필요
  user_metadata: {
    force_password_reset: true,
    display_name: 'Super Admin'
  }
})

// 기존 사용자 업데이트도 필요
if (existingUser) {
  await admin.auth.admin.updateUserById(userId, {
    app_metadata: { is_super_admin: true } // ✅ 추가 필요
  })
}
```

#### 평가: ⭐⭐⭐⭐⭐ (5/5)
- 보안성: ✅ 우수
- 실용성: ✅ 우수
- 구현 난이도: ✅ 낮음

---

### B. 권한 확인 (미들웨어 및 서버) ✅ **승인 (수정 필요)**

#### 제안 내용
- `middleware.ts`에서 `profiles` 조회 제거
- JWT `app_metadata.is_super_admin`만 사용

#### 현재 상태
```typescript
// middleware.ts (현재 - 문제 있음)
const { data: profile, error: profileError } = await supabase
  .from('profiles')
  .select('is_super_admin')
  .eq('id', user.id)
  .maybeSingle()
```

#### 수정 필요 사항
```typescript
// middleware.ts (수정 후)
const { data: { user }, error: authError } = await supabase.auth.getUser()
const isSuper = !!user?.app_metadata?.is_super_admin

if (!user) return NextResponse.redirect(new URL('/login', req.url))
if (!isSuper) return NextResponse.json(
  { error: 'Forbidden: Super admin access required' },
  { status: 403 }
)
```

#### ⚠️ 주의 사항
1. **쿠키 설정 누락**: 제안 코드에서 `set`, `remove` 함수가 빈 함수로 되어 있음
   ```typescript
   // ❌ 제안 코드 (문제)
   { cookies: { get: (k) => req.cookies.get(k)?.value, set: () => {}, remove: () => {} } }
   
   // ✅ 수정 필요
   { cookies: {
     get: (name: string) => req.cookies.get(name)?.value,
     set: (name: string, value: string, options?: any) => {
       req.cookies.set({ name, value, ...options })
       response.cookies.set({ name, value, ...options })
     },
     remove: (name: string, options?: any) => {
       req.cookies.set({ name, value: '', ...options })
       response.cookies.set({ name, value: '', ...options })
     },
   } as any }
   ```

2. **JWT 토큰 갱신**: `app_metadata` 변경 시 사용자가 재로그인해야 JWT에 반영됨
   - 부트스트랩 후 즉시 테스트 시 문제 발생 가능
   - 해결: 부트스트랩 스크립트에서 토큰 갱신 또는 재로그인 안내

#### 평가: ⭐⭐⭐⭐ (4/5)
- 보안성: ✅ 우수
- 실용성: ⚠️ JWT 갱신 이슈 고려 필요
- 구현 난이도: ✅ 낮음

---

### C. RLS 정책 ✅ **승인 (부분 수정 필요)**

#### 제안 내용
- RLS 정책에서 `auth.jwt()->'app_metadata'->>'is_super_admin'` 사용
- 테이블 조회/함수 재귀 금지

#### 현재 상태
```sql
-- 현재 (문제 있음)
create policy "superadmin all profiles" on public.profiles
  for all
  using ((select is_super_admin from public.me) is true) -- 순환 참조
```

#### 수정 필요 사항
```sql
-- 수정 후
create policy "super_select_all" on public.agencies
  for select using (
    coalesce((auth.jwt()->'app_metadata'->>'is_super_admin')::boolean, false)
  );

-- 일반 사용자 정책은 별도로 분리
create policy "agency_member_can_read" on public.agencies
  for select using (
    exists (
      select 1 from public.agency_members m
      where m.user_id = auth.uid() and m.agency_id = agencies.id
    )
  );
```

#### ⚠️ 주의 사항
1. **기존 RLS 정책 마이그레이션**: 약 **15개 이상의 마이그레이션 파일**에서 `public.me` 사용
   - `015_create_forms_system.sql`
   - `016_create_webinar_files.sql`
   - `017_create_giveaways.sql`
   - 등등...

2. **마이그레이션 순서**:
   - 1단계: 새 정책 추가 (기존 정책 유지)
   - 2단계: 테스트 및 검증
   - 3단계: 기존 정책 제거

#### 평가: ⭐⭐⭐⭐ (4/5)
- 보안성: ✅ 우수
- 실용성: ⚠️ 대량 마이그레이션 필요
- 구현 난이도: ⚠️ 중간 (마이그레이션 범위 큼)

---

### D. 슈퍼 대시보드/관리 API ✅ **승인**

#### 제안 내용
- 서비스 키 사용
- 커서 기반 페이지네이션
- 머티리얼라이즈드 뷰 고려

#### 현재 상태
- ✅ `app/(super)/super/dashboard/page.tsx` 존재
- ✅ `app/(super)/super/agencies/page.tsx` 존재
- ✅ `app/(super)/super/clients/page.tsx` 존재
- ⚠️ 서비스 키 사용 여부 확인 필요

#### 평가: ⭐⭐⭐⭐⭐ (5/5)
- 보안성: ✅ 우수
- 실용성: ✅ 우수
- 구현 난이도: ✅ 낮음

---

### E. 네비게이션/레이아웃 ✅ **승인**

#### 제안 내용
- 사이드바 구현
- 커서 기반 페이지네이션

#### 현재 상태
- ✅ `app/(super)/super/_components/SuperSidebar.tsx` 존재
- ✅ 커서 기반 페이지네이션 패턴 존재 (채팅 등)

#### 평가: ⭐⭐⭐⭐⭐ (5/5)
- 보안성: ✅ N/A
- 실용성: ✅ 우수
- 구현 난이도: ✅ 낮음

---

### F. 감사 로그 & 운영 가드 ✅ **승인**

#### 제안 내용
- `audit_logs` 테이블 활용
- 레이트 리밋/CSRF 보호

#### 현재 상태
- ✅ `audit_logs` 테이블 존재
- ⚠️ 레이트 리밋/CSRF 보호 미구현

#### 평가: ⭐⭐⭐⭐ (4/5)
- 보안성: ✅ 우수
- 실용성: ✅ 우수
- 구현 난이도: ⚠️ 중간

---

## 🔧 프로젝트 맞춤 수정 사항

### 1. 부트스트랩 스크립트 수정

**파일**: `scripts/seed-super-admin.ts`

```typescript
// 추가 필요
app_metadata: { is_super_admin: true }

// 기존 사용자 업데이트도 추가
if (existingUser) {
  await admin.auth.admin.updateUserById(userId, {
    app_metadata: { is_super_admin: true }
  })
}
```

### 2. 미들웨어 수정 (쿠키 설정 보완)

**파일**: `middleware.ts`

```typescript
// 제안 코드의 쿠키 설정 부분 수정 필요
// 현재 프로젝트의 쿠키 설정 방식 유지
```

### 3. 인증 가드 수정

**파일**: `lib/auth/guards.ts`

```typescript
// requireSuperAdmin, requireAgencyMember, requireClientMember
// 모두 JWT app_metadata 사용하도록 수정
```

### 4. 클라이언트 측 코드 수정

**파일**: `app/page.tsx`

```typescript
// profiles 조회 제거
// 서버 API만 사용
```

### 5. RLS 정책 마이그레이션

**새 마이그레이션 파일**: `025_migrate_rls_to_jwt_claims.sql`

```sql
-- 모든 테이블의 RLS 정책을 JWT 클레임 기반으로 변경
-- 기존 정책은 주석 처리 후 새 정책 추가
```

---

## 📊 구현 우선순위

### Phase 1: 즉시 해결 (RLS 무한 재귀)
1. ✅ 부트스트랩 스크립트 수정 (`app_metadata` 추가)
2. ✅ 미들웨어 수정 (JWT 클레임 사용)
3. ✅ 클라이언트 측 코드 수정 (`app/page.tsx`)

### Phase 2: 단기 (1-2주)
1. ✅ 인증 가드 수정 (`lib/auth/guards.ts`)
2. ✅ RLS 정책 마이그레이션 (주요 테이블)
3. ✅ 서버 API 수정 (JWT 클레임 사용)

### Phase 3: 중기 (1개월)
1. ✅ 전체 RLS 정책 마이그레이션
2. ✅ 레이트 리밋/CSRF 보호 구현
3. ✅ 모니터링 및 알림 시스템

---

## ⚠️ 주의 사항 및 리스크

### 1. JWT 토큰 갱신 이슈
- **문제**: `app_metadata` 변경 시 사용자가 재로그인해야 JWT에 반영
- **해결**: 부트스트랩 후 재로그인 안내 또는 토큰 갱신 로직 추가

### 2. 기존 사용자 마이그레이션
- **문제**: 기존 슈퍼어드민의 `app_metadata` 설정 필요
- **해결**: 마이그레이션 스크립트 또는 부트스트랩 스크립트 재실행

### 3. RLS 정책 마이그레이션 범위
- **문제**: 약 15개 이상의 마이그레이션 파일 수정 필요
- **해결**: 단계적 마이그레이션 (주요 테이블 → 전체)

### 4. 테스트 범위
- **문제**: 많은 파일 수정으로 인한 테스트 범위 확대
- **해결**: 단계적 배포 및 철저한 테스트

---

## ✅ 최종 권장 사항

### 승인 조건
1. ✅ **부트스트랩 스크립트 수정** (필수)
2. ✅ **미들웨어 쿠키 설정 보완** (필수)
3. ✅ **단계적 마이그레이션 계획** (권장)
4. ✅ **JWT 토큰 갱신 처리** (권장)

### 구현 순서
1. **즉시**: 부트스트랩 스크립트 수정 + 미들웨어 수정
2. **1주 내**: 클라이언트 코드 수정 + 인증 가드 수정
3. **2주 내**: 주요 RLS 정책 마이그레이션
4. **1개월 내**: 전체 마이그레이션 완료

---

## 📚 참고 자료

### 관련 파일
- `scripts/seed-super-admin.ts`
- `middleware.ts`
- `lib/auth/guards.ts`
- `app/page.tsx`
- `supabase/migrations/*.sql`

### Supabase 문서
- [JWT Claims](https://supabase.com/docs/guides/auth/jwts)
- [Row Level Security](https://supabase.com/docs/guides/auth/row-level-security)
- [Admin API](https://supabase.com/docs/reference/javascript/auth-admin)

---

**검토 완료일**: 2025-11-17  
**검토자**: AI Assistant  
**버전**: 1.0

